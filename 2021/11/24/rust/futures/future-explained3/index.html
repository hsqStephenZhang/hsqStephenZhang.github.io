

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="mem::swap(Rust, ğŸ¦€ )">
  <meta name="keywords" content="">
  
    <meta name="description" content="withoutboats æ˜¯ Rust å¼‚æ­¥çš„ä¸»è¦è´Ÿè´£äººï¼Œä»–åœ¨ä¸€æ¬¡åˆ†äº«ä¸­è¯¦ç»†æè¿°äº† Pin çš„æ¼”å˜è¿‡ç¨‹å’ŒèƒŒåçš„å¿ƒè·¯å†ç¨‹ 1. Future æ¨¡å¼å¼•å…¥åœ¨ Rust ä¹‹å‰çš„å¾ˆå¤šè¯­è¨€ï¼Œç»å¤§å¤šæ•°é€‰æ‹©äº†å›è°ƒæœºåˆ¶å®ç°çš„å¼‚æ­¥é€»è¾‘ï¼Œæ¯”å¦‚Cè¯­è¨€ä¸­çš„ libeventï¼Œå†è¿˜æœ‰ nodejs ä¸­çš„ callbackã€‚é¦–å…ˆåœ¨ Rust ä¸­ï¼Œä½ å¾ˆéš¾å†™å‡º nodejs é‚£ç§å›è°ƒæ¨¡å¼çš„å¼‚æ­¥ä»£ç ï¼Œä¸‹é¢æ˜¯ä¸€å°æ®µå…¸å‹çš„ nodejs">
<meta property="og:type" content="article">
<meta property="og:title" content="future explained(3)">
<meta property="og:url" content="https://hsqstephenzhang.github.io/2021/11/24/rust/futures/future-explained3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="withoutboats æ˜¯ Rust å¼‚æ­¥çš„ä¸»è¦è´Ÿè´£äººï¼Œä»–åœ¨ä¸€æ¬¡åˆ†äº«ä¸­è¯¦ç»†æè¿°äº† Pin çš„æ¼”å˜è¿‡ç¨‹å’ŒèƒŒåçš„å¿ƒè·¯å†ç¨‹ 1. Future æ¨¡å¼å¼•å…¥åœ¨ Rust ä¹‹å‰çš„å¾ˆå¤šè¯­è¨€ï¼Œç»å¤§å¤šæ•°é€‰æ‹©äº†å›è°ƒæœºåˆ¶å®ç°çš„å¼‚æ­¥é€»è¾‘ï¼Œæ¯”å¦‚Cè¯­è¨€ä¸­çš„ libeventï¼Œå†è¿˜æœ‰ nodejs ä¸­çš„ callbackã€‚é¦–å…ˆåœ¨ Rust ä¸­ï¼Œä½ å¾ˆéš¾å†™å‡º nodejs é‚£ç§å›è°ƒæ¨¡å¼çš„å¼‚æ­¥ä»£ç ï¼Œä¸‹é¢æ˜¯ä¸€å°æ®µå…¸å‹çš„ nodejs">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hsqstephenzhang.github.io/images/pin1.png">
<meta property="og:image" content="https://hsqstephenzhang.github.io/images/pin1.png">
<meta property="article:published_time" content="2021-11-24T06:04:29.000Z">
<meta property="article:modified_time" content="2022-01-22T14:36:58.858Z">
<meta property="article:author" content="mem::swap(Rust, ğŸ¦€ )">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://hsqstephenzhang.github.io/images/pin1.png">
  
  
  <title>future explained(3) - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"hsqstephenzhang.github.io","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>mem::swap</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-user-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="future explained(3)">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-11-24 14:04" pubdate>
        November 24, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      11k å­—
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      96 åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">future explained(3)</h1>
            
            <div class="markdown-body">
              <p>withoutboats æ˜¯ Rust å¼‚æ­¥çš„ä¸»è¦è´Ÿè´£äººï¼Œä»–åœ¨ä¸€æ¬¡åˆ†äº«ä¸­è¯¦ç»†æè¿°äº† Pin çš„æ¼”å˜è¿‡ç¨‹å’ŒèƒŒåçš„å¿ƒè·¯å†ç¨‹</p>
<h2 id="1-Future-æ¨¡å¼å¼•å…¥"><a href="#1-Future-æ¨¡å¼å¼•å…¥" class="headerlink" title="1. Future æ¨¡å¼å¼•å…¥"></a>1. Future æ¨¡å¼å¼•å…¥</h2><p>åœ¨ Rust ä¹‹å‰çš„å¾ˆå¤šè¯­è¨€ï¼Œç»å¤§å¤šæ•°é€‰æ‹©äº†å›è°ƒæœºåˆ¶å®ç°çš„å¼‚æ­¥é€»è¾‘ï¼Œæ¯”å¦‚Cè¯­è¨€ä¸­çš„ libeventï¼Œå†è¿˜æœ‰ nodejs ä¸­çš„ callbackã€‚<br>é¦–å…ˆåœ¨ Rust ä¸­ï¼Œä½ å¾ˆéš¾å†™å‡º <code>nodejs</code> é‚£ç§å›è°ƒæ¨¡å¼çš„å¼‚æ­¥ä»£ç ï¼Œä¸‹é¢æ˜¯ä¸€å°æ®µå…¸å‹çš„ <code>nodejs</code> å›è°ƒæ¨¡å‹</p>
<figure class="highlight rust"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">get_foos</span></span>(client: Client) -&gt; <span class="hljs-keyword">impl</span> Future&lt;Output = <span class="hljs-built_in">Vec</span>&lt;Response&gt;&gt;&#123;<br>    client.get_index(<span class="hljs-string">&quot;/foos&quot;</span>).and_then(|index|&#123;<br>        client.get_responses(&amp;index).collect()<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ Rust ä¸­ï¼Œä¸”ä¸è¯´å›è°ƒåœ°ç‹±é—®é¢˜ï¼Œå…³é”®æ˜¯è¿™ç§å†™æ³• <strong>æ ¹ æœ¬ ç¼– è¯‘ ä¸ è¿‡!</strong></p>
<p>è¿™æ®µä»£ç ï¼Œåœ¨ Rust ä¸­å­˜åœ¨å¾ˆä¸¥é‡çš„æ‰€æœ‰æƒå’Œç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼Œä½ ä¼šå¾—åˆ°å„ç§å„æ ·çš„ç¼–è¯‘é”™è¯¯ã€‚æ ¹æ® rustc çš„æç¤ºï¼Œç¼ç¼è¡¥è¡¥ï¼Œä½ æˆ–è®¸ä¼šç”¨ä¸‹é¢è¿™ç§æ–¹å¼å»å¤„ç†ï¼Œä¹Ÿç¡®å®å¯ä»¥ç¼–è¯‘ï¼Œä½†ä¹Ÿä»…æ­¤è€Œå·²ã€‚ä¸”ä¸è¯´ä¸ºäº†ç¼–è¯‘é€šè¿‡è€Œä»˜å‡ºçš„åŠªåŠ›ï¼Œå•å•æ˜¯ Arc å’Œ Mutex å¸¦æ¥çš„é¢å¤–å¼€é”€ï¼Œä¹Ÿæ˜¯æ— æ³•æ¥å—çš„ã€‚å½“åˆ›å»ºå¤§å‹ç¨‹åºæ—¶ï¼Œç®€ç›´æ— æ³•æƒ³è±¡ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">get_foos</span></span>(client: Client) -&gt; <span class="hljs-keyword">impl</span> Future&lt;Output = <span class="hljs-built_in">Vec</span>&lt;Response&gt;&gt;&#123;<br>    <span class="hljs-keyword">let</span> client: Arc&lt;Mutex&lt;Client&gt;&gt; = Arc::new(Mutex::new(Client));<br>    <span class="hljs-keyword">let</span> client2 = client.clone();<br><br>    client.lock().unwrap().get_index(<span class="hljs-string">&quot;/foos&quot;</span>).and_then(<span class="hljs-keyword">move</span> |index|&#123;<br>        client2.lock().unwrap().get_responses(&amp;index).collect()<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å› æ­¤ï¼ŒRust å›¢é˜Ÿè¿›è¡Œè®¾è®¡äº†ä¸€å¥—åŸºäº Future çš„ APIï¼Œæå‡ºäº† async/await è¿™ç»„å…³é”®å­—ï¼Œå°†å¼‚æ­¥ä»£ç è½¬æ¢æˆåŒæ­¥æ¨¡å‹ï¼Œè¿™ä¸ä»…å›é¿äº†ä¸Šé¢çš„æ‰€æœ‰æƒé—®é¢˜ï¼Œè¿˜æ›´åŠ ç¬¦åˆäººä½“å·¥ç¨‹å­¦ã€‚</p>
<p>è¿™ç§å†™æ³•éå¸¸æ¥è¿‘ <code>blocking io</code>ï¼Œç¨‹åºå‘˜èƒ½è½»æ˜“çœ‹å‡ºæ‰§è¡Œçš„é€»è¾‘ï¼Œå´èƒ½å¤Ÿä»¥å¼‚æ­¥çš„æ–¹å¼è¿è¡Œï¼Œè¿™ä¸»è¦å½’åŠŸäº Rust ç¼–è¯‘å™¨å¯¹äº async ä»£ç å—çš„é«˜çº§æŠ½è±¡ï¼Œasync block ä¼šè¢«ç¿»è¯‘æˆä¸€ä¸ª<strong>çŠ¶æ€æœº GenFuture</strong>ï¼ˆåŒ¿åç»“æ„ä½“ï¼‰ï¼Œå¹¶ä¸”å…¶ä¸­ä»»ä½•è·¨è¶Š await ä»£ç å—çš„å¼•ç”¨ï¼Œéƒ½ä¼šå°†è¢«å¼•ç”¨çš„å˜é‡å’Œå¼•ç”¨ä¿å­˜åˆ°å½“å‰ä¸º async ä»£ç å—ç”Ÿæˆçš„çŠ¶æ€æœºä¸­ï¼Œæ¯ä¸€ä¸ª await ç‚¹éƒ½æ˜¯çŠ¶æ€çš„è½¬å˜æ—¶æœºã€‚  </p>
<p>è¿™æ ·çš„è®¾è®¡æ˜¯ååˆ†ä¼˜é›…çš„ï¼Œä¹Ÿéå¸¸æœ‰æ•ˆï¼Œä½†æ˜¯å´å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼š<strong>è‡ªå¼•ç”¨</strong> ã€‚æ¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š  </p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">get_foos</span></span>(client: Client) -&gt; <span class="hljs-built_in">Vec</span>&lt;Response&gt;&#123;<br>    <span class="hljs-keyword">let</span> index = client.get_index(<span class="hljs-string">&quot;/foos&quot;</span>).<span class="hljs-keyword">await</span>; <span class="hljs-comment">// State &#123; Client, &amp;mut Client&#125;</span><br>    client.get_responses(&amp;index).collect().<span class="hljs-keyword">await</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>let index = client.get_index(&quot;/foos&quot;).await;</code> å­˜åœ¨ä¸€ä¸ªè·¨è¶Š await å…³é”®å­—çš„å¯¹äº client çš„å¼•ç”¨ï¼Œå› æ­¤ï¼Œå¿…é¡»è¦å°† client å’Œ &amp;mut client éƒ½ä¿å­˜åœ¨çŠ¶æ€æœºä¸­ã€‚ï¼ˆè¿™é‡Œä¸å»è€ƒè™‘æ‰‹åŠ¨æ„é€ çš„é—®é¢˜ï¼Œéœ€è¦ unsafe ä»£ç æ“ä½œè£¸æŒ‡é’ˆæ‰å¯ä»¥ï¼Œç¼–è¯‘å™¨å®ç°èµ·æ¥ä¼šè½»æ¾å¾ˆå¤šï¼‰</p>
<p>å¦‚æœæŒ‰ç…§æœ€åŸå§‹çš„ Future æ¥å£( <code>fn poll(&amp;mut self, ctx: &amp;mut Context&lt;&#39;_&gt;)</code>)ï¼Œæˆ‘ä»¬å¾ˆè½»æ˜“å°±èƒ½åœ¨å®‰å…¨ä»£ç ä¸­è®© Rust ç¨‹åºå´©æºƒï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">bar</span></span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> future = get_foos(...);<br>    future.poll(...);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> future2 = get_foos(...); <span class="hljs-comment">// ä¸ºäº†é˜²æ­¢ let mut future2 = future åªæ˜¯ä¸€ä¸ªåˆ«åï¼Œå¼ºåˆ¶åˆå§‹åŒ– future2ï¼Œä»è€Œä¸‹é¢çš„ future2 = future æˆä¸ºä¸€ä¸ª memcpy æ“ä½œ</span><br>    future2 = future;       <span class="hljs-comment">// è‡ªå¼•ç”¨ç»“æ„å·²ç»å¤±æ•ˆï¼Œå› ä¸º future å’Œ future2 éƒ½æ˜¯æ ˆä¸Šçš„ç»“æ„</span><br>    future2.poll(...); <span class="hljs-comment">// æ­¤æ—¶å®Œå…¨æ— æ³•æ§åˆ¶ poll ä¸­æ˜¯å¦ä¼šä½¿ç”¨è¯¥å¤±æ•ˆçš„è‡ªå¼•ç”¨ ï¼Œ</span><br>                       <span class="hljs-comment">// äº§ç”Ÿäº† undefined behavior</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼šå½“ poll ä¸€ä¸ª Future ä¹‹åï¼Œæˆ‘ä»¬ç§»åŠ¨äº†å®ƒåŸæœ¬çš„ä½ç½®ï¼Œå¯¼è‡´ Future ä¸­çš„<strong>è‡ªå¼•ç”¨ç»“æ„å¤±æ•ˆ</strong>ã€‚</p>
<p>è¿™ä¼¼ä¹æœ‰ä¸€ç‚¹è«åå…¶å¦™ï¼Œæ·±ç©¶ä¸€ä¸‹æ ¹æºï¼Œä½ ä¼šå‘ç°ï¼Œè¿™å’Œå †ã€æ ˆçš„ç‰¹æ€§æœ‰å…³ã€‚</p>
<p>åœ¨æ ˆä¸Šåˆ†é…çš„å˜é‡ï¼Œå¦‚æœç§»åŠ¨äº†æ‰€æœ‰æƒï¼Œå…¶å¤§æ¦‚ç‡ï¼ˆå¦‚æœä¸æ˜¯é€šè¿‡åˆ«åå¤ç”¨è¿™å—å†…å­˜çš„è¯ï¼‰ä¹Ÿä¼šé‡æ–°åˆ†é…ä¸€å—å†…å­˜ï¼Œå¹¶ä¸”åŸå…ˆçš„å†…å­˜ä¼šå¤±æ•ˆã€‚å‚ç…§ä¸‹å›¾ï¼Œåœ¨ <code>state2 = state1;</code> ä¹‹åï¼Œä¼šå°† state1 ä¸­çš„å†…å®¹å®Œå®Œæ•´æ•´æ‹·è´åˆ° state2 ä¸­ï¼Œä½†æ˜¯ State ä¸­çš„ <code>&amp;mut client</code>ï¼Œè¿˜æŒ‡å‘ state1 é‚£å—å·²ç»å¤±æ•ˆçš„å†…å­˜ï¼Œè¿™æ‰äº§ç”Ÿçš„ UB è¡Œä¸º</p>
<p><img src="/images/pin1.png" srcset="/img/loading.gif" lazyload alt="pin on stack"></p>
<p>è§£å†³çš„åŠæ³•å¾ˆç®€å•ï¼šå †å†…å­˜åˆ†é…ï¼</p>
<p>å¦‚æœæˆ‘ä»¬åœ¨æ ˆä¸Šåªä¿ç•™ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å †ä¸Šåˆ†é…çš„ Stateï¼Œé‚£ä¹ˆï¼Œå½“æ‰€æœ‰æƒå‘ç”Ÿè½¬ç§»çš„æ—¶å€™ï¼Œä»…ä»…æ˜¯ä¹‹å‰è¿™ä¸ªæŒ‡é’ˆå¤±æ•ˆäº†ï¼Œå †ä¸Šçš„<strong>å€¼å¼•ç”¨ç»“æ„</strong>å¹¶æ²¡æœ‰ç§»åŠ¨ï¼Œä¹Ÿæ²¡æœ‰è¢«é‡Šæ”¾ï¼Œä»ç„¶æ˜¯æœ‰æ•ˆçš„ã€‚</p>
<p><img src="/images/pin1.png" srcset="/img/loading.gif" lazyload alt="pin on heap"></p>
<p>è¿™ç§æ¨¡å¼ï¼Œå°±å¥½åƒå°† State é’‰(Pin)åœ¨äº†å †ç©ºé—´ä¸­ï¼Œæ— è®ºæ ˆä¸Šçš„æŒ‡é’ˆæ€ä¹ˆç§»åŠ¨ï¼Œå †ä¸Šçš„å†…å­˜éƒ½ä¸ä¼šå—åˆ°åŠç‚¹å½±å“ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> state3 = state2;<br><span class="hljs-keyword">let</span> state4 = state3; <span class="hljs-comment">// totally fine</span><br>...<br><br></code></pre></td></tr></table></figure>

<h2 id="2-Future-æ”¹è¿›ï¼ŒPin-å¼•å…¥"><a href="#2-Future-æ”¹è¿›ï¼ŒPin-å¼•å…¥" class="headerlink" title="2. Future æ”¹è¿›ï¼ŒPin å¼•å…¥"></a>2. Future æ”¹è¿›ï¼ŒPin å¼•å…¥</h2><p>withoutboats ä½œä¸º Rust å¼‚æ­¥æœºåˆ¶çš„ä¸»è¦è®¾è®¡è€…ï¼Œé’ˆå¯¹åŸå§‹çš„ Future trait æå‡ºäº†å‡ ä¸ªæ–¹æ¡ˆï¼š</p>
<h3 id="2-1-unsafe-æ ‡è®°"><a href="#2-1-unsafe-æ ‡è®°" class="headerlink" title="2.1 unsafe æ ‡è®°"></a>2.1 unsafe æ ‡è®°</h3><p>è¿™ä¸ªæ–¹æ¡ˆè§£å†³çš„æ€è·¯æ˜¯ï¼šä¸ºäº†ä½¿ç”¨ Futureï¼Œä½ å¿…é¡»è¦ç¡®ä¿ SAFETYï¼šè¯¥ Future ä¸€æ—¦è¢« poll ä¹‹åï¼Œç›´åˆ°å…¶è¢« Drop éƒ½ä¸ä¼šè¢«ç§»åŠ¨ã€‚<br>å¯¹äºåˆ†é…åœ¨å †ä¸Šçš„ future å¤©ç”Ÿå°±æ»¡è¶³è¿™ä¸€ç‚¹è¦æ±‚ï¼Œæ‰€ä»¥è¿™ä¸»è¦æ˜¯é’ˆå¯¹åœ¨æ ˆä¸Šçš„å†…å­˜è€Œè¨€çš„çº¦æŸã€‚</p>
<p>è™½ç„¶è¿™ç¡®å®å¯ä»¥è§£å†³ç°é˜¶æ®µ Future ç§»åŠ¨å¯¼è‡´çš„é—®é¢˜ï¼Œä½†è¿™ä¼šå¸¦æ¥ä¸€ä¸ªä¸å¾—ä¸è€ƒè™‘çš„é—®é¢˜ï¼šæœ¬å°±ä¸å—å¤§å®¶æ¬¢è¿çš„ unsafe å¯èƒ½ä¼šéå¸ƒä»£ç åº“ï¼è€Œä¸”ç›¸å½“äºæŠŠé”…éƒ½ç”©ç»™äº†ç”¨æˆ·ï¼Œå¤§å¤§åŠ é‡äº†å¼€å‘äººå‘˜å¿ƒæ™ºè´Ÿæ‹…ï¼Œè¯¥æ–¹æ¡ˆä½œä¸ºé’ˆå¯¹ Future æ¥å£çš„ç¬¬ä¸€æ¬¡æ”¹è¿›ï¼Œä¹Ÿå°±åˆ°æ­¤ä¸ºæ­¢ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Future</span></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Output</span></span>;<br><br>    <span class="hljs-keyword">unsafe</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">poll</span></span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, ctx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-symbol">&#x27;_</span>&gt;) -&gt; Poll&lt;Self::Output&gt;;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-Pin-çš„åŸå§‹ç‰ˆæœ¬"><a href="#2-2-Pin-çš„åŸå§‹ç‰ˆæœ¬" class="headerlink" title="2.2 Pin çš„åŸå§‹ç‰ˆæœ¬"></a>2.2 Pin çš„åŸå§‹ç‰ˆæœ¬</h3><p>unsafe Future Trait çš„æ–¹æ¡ˆè¢« pass ä¹‹åï¼ŒRust å›¢é˜Ÿå¼€å§‹å¯»æ±‚åˆ«çš„è§£å†³æ–¹å¼ï¼Œå¹¶æå‡ºäº† Pin çš„æ¦‚å¿µã€‚</p>
<p>ä½† Pin æœ€ä¸€å¼€å§‹å¹¶ä¸åƒç°åœ¨è¿™æ ·ç®€æ´ï¼Œå…¶ä¹Ÿæ˜¯ç»å†äº†å¾ˆå¤šè®¾è®¡ä¸Šçš„æ”¹è¿›ã€‚æœ€ä¸€å¼€å§‹çš„è®¾è®¡å…¶å®é•¿ä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PinMut</span></span>&lt;<span class="hljs-symbol">&#x27;a</span>, T&gt;(&amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> T);<br><br><span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">&#x27;a</span>, T&gt; PinMut&lt;<span class="hljs-symbol">&#x27;a</span>, T&gt; &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">get_mut_unchecked</span></span>(<span class="hljs-keyword">self</span>) -&gt; &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> T&#123;<br>        <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PinBox</span></span>&lt;T&gt;(<span class="hljs-built_in">Box</span>&lt;T&gt;);<br><br><span class="hljs-keyword">impl</span>&lt;T&gt; <span class="hljs-built_in">From</span>&lt;<span class="hljs-built_in">Box</span>&lt;T&gt;&gt; <span class="hljs-keyword">for</span> PinBox&lt;T&gt; &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">from</span></span>(b: <span class="hljs-built_in">Box</span>&lt;T&gt;) -&gt; PinBox&lt;T&gt; &#123;<br>        PinBox(b)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T&gt; PinBox&lt;T&gt; &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">as_mut</span></span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt;(&amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) -&gt; &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> T&#123;<br>        PinMut(&amp;<span class="hljs-keyword">mut</span> *<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Future</span></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Output</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">poll</span></span>(<span class="hljs-keyword">self</span>: PinMut&lt;<span class="hljs-symbol">&#x27;_</span>, <span class="hljs-keyword">Self</span>&gt;, ctx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-symbol">&#x27;_</span>&gt;) -&gt; Poll&lt;Self::Output&gt;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œå¼•å…¥äº† <code>PinBox</code> å’Œ <code>PinMut</code> ä¸¤ä¸ªæ¦‚å¿µï¼Œéƒ½æ˜¯å¯¹äºæŒ‡é’ˆçš„å°è£…ï¼Œæœ€å¤§çš„ä¸åŒæ˜¯ï¼Œå¦‚æœæƒ³è¦é€šè¿‡ <code>PinMut</code> è·å–åˆ°èƒŒåçš„æŒ‡é’ˆï¼Œå¿…é¡»è¦é€šè¿‡éå®‰å…¨æ–¹æ³•å®Œæˆï¼Œè€Œå¯¹äº <code>PinBox</code> è€Œè¨€ï¼Œåˆ™æ˜¯å¯ä»¥ç›´æ¥åœ¨å®‰å…¨ä»£ç ä¸­è·å– Box èƒŒåçš„å¯¹è±¡æŒ‡é’ˆã€‚  </p>
<p>è¿™ç§å°è£…ï¼Œå¸¦æ¥äº†ä¸€ä¸ªå¾ˆå¤§çš„å¥½å¤„ï¼šå¦‚æœæƒ³è¦é€šè¿‡ PinMut è·å–èƒŒåçš„å¼•ç”¨ï¼Œåªèƒ½é€šè¿‡ get_mut_unchecked è¿™ç§ unsafe çš„æ–¹å¼ï¼Œé‚£ä¹ˆï¼Œå½“æˆ‘ä»¬å°† Future çš„ self ç±»å‹é™å®šä¸º <code>PinMut&lt;&#39;_, Self&gt;</code> çš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°ï¼Œå¹¶ä¸æ˜¯é‚£ä¹ˆè½»æ˜“å°±èƒ½è·å–åˆ° <code>&amp;mut self</code> çš„å“¦ï¼Œå¿…é¡»è¦ç¡®ä¿è¿™ä¸ªæ“ä½œçš„ <strong>SAFETY</strong>ï¼Œä¹Ÿå°±ä¸å¯èƒ½åœ¨å®‰å…¨ä»£ç ä¸­ï¼Œç›´æ¥è·å–åˆ° &amp;mut selfï¼Œç»§è€Œå¯¼è‡´ future ä¸­å†…å®¹è¢«è½»æ˜“ç§»åŠ¨ã€‚å¹¶ä¸”ï¼ŒåŸºäºè¿™ä¸¤ä¸ªæŠ½è±¡ï¼Œæ­£ç¡®æ€§è¯æ˜èµ·æ¥æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> a = PinMut(&amp;<span class="hljs-keyword">mut</span> p);<br><span class="hljs-comment">// error to compile</span><br>mem::swap(a.get_mut_unchecked(),&amp;<span class="hljs-keyword">mut</span> something_else);<br><span class="hljs-comment">// ok to compile, but usage of unsafe is wrong</span><br>mem::swap(<span class="hljs-keyword">unsafe</span> &#123; a.get_mut_unchecked() &#125;,&amp;<span class="hljs-keyword">mut</span> something_else);<br><br></code></pre></td></tr></table></figure>

<p>è¿™æ®µè¯ä¸­è¿˜å¼•å…¥äº†ä¸€ç‚¹ï¼Œå¦‚æœèƒ½å¤Ÿåœ¨å®‰å…¨ä»£ç ä¸­ï¼Œè·å–åˆ°è‡ªå¼•ç”¨ç»“æ„çš„å¯å˜å¼•ç”¨ï¼Œä¹Ÿä¼šå¯¼è‡´ Rust ç»™æˆ‘ä»¬åšå‡ºçš„å®‰å…¨è§„èŒƒè½°ç„¶å€’å¡Œ<br>ç»“åˆä¹‹å‰çš„å †ã€æ ˆåˆ†é…çš„ç‰¹ç‚¹ï¼Œå®é™…ä½¿ç”¨ä¸­ï¼Œä¼šå…ˆå°†å…¶åˆ†é…åœ¨å †ä¸Šï¼Œä¿è¯ä¸ä¼šå› ä¸º <code>let mut future2 = future1;</code> è¿™ç§è¯­ä¹‰å°†å…¶ç§»åŠ¨ï¼Œå…¶æ¬¡ï¼Œå°±æ˜¯éµå®ˆ PinMut ç»™æˆ‘ä»¬çš„çº¦æŸï¼Œä¿è¯ä¸ä¼šè·å–åˆ°å¯å˜å¼•ç”¨è€Œç§»åŠ¨ã€‚</p>
<p>ç›¸æ¯”å¦‚ç¬¬ä¸€ä¸ª unsafe ææ¡ˆï¼Œæˆ‘ä»¬è™½ç„¶å…ä¸äº†å’Œ unsafe æ‰“äº¤é“ï¼Œä½†æ˜¯å·²ç»å¯ä»¥å¾—åˆ°ä¸€ä¸ªéå¸¸å¹²å‡€çš„ Future æ¥å£ï¼Œè°ƒç”¨ poll ä¹Ÿä¸éœ€è¦å†ç”¨ unsafe æ¥æ–¹å¼è¯¯ç”¨äº†ï¼Œç›¸å½“äºæ˜¯å°† unsafe é€»è¾‘è½¬ç§»åˆ°äº†å†…å±‚å®ç°ä¸­ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">spawn</span></span>&lt;F: Future&gt;(f: F)&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> fut = PinBox::from(<span class="hljs-built_in">Box</span>::new(f));<br>    <br>    <span class="hljs-comment">// safe the fut to somewhere</span><br><br>    <span class="hljs-comment">// handin to the executor</span><br><br>    <span class="hljs-comment">// construct PinMut, then poll</span><br>    fut.as_mut().poll(...);<br>&#125; <br></code></pre></td></tr></table></figure>

<p>ä½†å³ä½¿æ˜¯å†…å±‚çš„ unsafe é€»è¾‘ï¼Œä¹Ÿä¼šç»™å¼€å‘äººå‘˜å¸¦æ¥å¾ˆå¤§çš„å¿ƒæ™ºè´Ÿæ‹…ï¼</p>
<p>åœ¨ä¸Šé¢çš„çº¦æŸä¸‹ï¼Œæˆ‘ä»¬å¦‚æœæƒ³è¦åœ¨ poll æ–¹æ³•ä¸­æ›´æ–° self çš„çŠ¶æ€ï¼Œæˆ–è€…è°ƒç”¨ self æŸä¸€äº› field çš„æ–¹æ³•ï¼Œéƒ½è¦é¦–å…ˆé€šè¿‡éå®‰å…¨ä»£ç ï¼Œè·å– &amp;mut Selfï¼Œç›¸å½“äºå£°æ˜ï¼šæˆ‘éµå®ˆ unsafe èµ‹äºˆæˆ‘çš„ä¸€åˆ‡æƒåŠ›ï¼Œæˆ‘ä¿è¯ä¸ä¼šç§»åŠ¨ selfã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">AsyncIoHandle</span></span>&#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">poll_read</span></span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>,buf: &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-built_in">u8</span>]) -&gt;Poll&lt;<span class="hljs-built_in">usize</span>&gt;&#123;<br>        ...<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IoFuture</span></span> &#123;<br>    buf: <span class="hljs-built_in">Vec</span>&lt;<span class="hljs-built_in">u8</span>&gt;,<br>    file: AsyncFileHandle<br>&#125;<br><br><span class="hljs-keyword">impl</span> Future <span class="hljs-keyword">for</span> IoFuture &#123;<br>    tyep Output = <span class="hljs-built_in">usize</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">poll</span></span>(<span class="hljs-keyword">self</span>: PinMut&lt;<span class="hljs-symbol">&#x27;_</span>, <span class="hljs-keyword">Self</span>&gt;, x: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-symbol">&#x27;_</span>&gt;) -&gt; Poll&lt;Self::Output&gt;&#123;<br>        <span class="hljs-comment">// wont&#x27;t compile </span><br>        <span class="hljs-comment">// self.file.poll_read(&amp;mut self.buf[..]) </span><br><br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            <span class="hljs-keyword">let</span> this: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">Self</span> = <span class="hljs-keyword">self</span>.get_mut_unchecked();<br>            this.file.poll(&amp;<span class="hljs-keyword">mut</span> this.buf[..]);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ç§æ¼äººçš„é—®é¢˜å¯¹äº <strong>Leaf Future</strong> å°¤ä¸ºä¸¥é‡ã€‚æ‰€è°“çš„ <strong>Leaf Future</strong>ï¼Œå…¶å®æ˜¯é¢å‘åº•å±‚ Io(reactor)ã€éœ€è¦æ‰‹åŠ¨å®ç°çš„ Futureï¼Œ<strong>Non-Leaf Future</strong> å°±æ˜¯é€šè¿‡ async await è‡ªåŠ¨ç”Ÿæˆçš„ Futureï¼ŒåŒ…å«äº†ä¸‹é¢çš„æ‰€æœ‰ç»“ç‚¹ï¼Œnon-leaf or leafã€‚æ›´ä»¤äººæ— å¥ˆçš„ä¸€ç‚¹æ˜¯ï¼Œå¯¹äº 99% æ‰‹åŠ¨å®ç°çš„ <code>Leaf Future</code>ï¼Œå¹¶æ²¡æœ‰ <code>self referential</code> çš„é—®é¢˜ï¼Œä»éœ€è¦ä½¿ç”¨ unsafeã€‚  async/await ä¸­çš„ <code>self referential</code> ç®—æ˜¯è§£å†³ï¼Œä½†åˆå‘åŠ›è¿‡çŒ›ï¼Œä¸€æ£’å­æ‰“æ­»äº†æ›´å¤šçš„ <strong>good future</strong>ã€‚</p>
<p>æ€»ç»“ä¸€ç‚¹ï¼š<strong>ç›®å‰ä¸ºæ­¢ï¼Œé€šè¿‡ PinMut å’Œ PinBox çš„æŠ½è±¡ï¼Œå·²ç»è§£å†³äº† executor ä¸­çš„é—®é¢˜(æ¯”å¦‚éœ€è¦ä½¿ç”¨ unsafe)ï¼Œæä¾›äº†æ˜“ç”¨çš„ Future::poll æ¥å£ï¼Œä½†æ˜¯å¯¹äº reactor ä»æ— å¤ªå¥½çš„åŠæ³•ã€‚PinMut å’Œ PinBox çš„æ­£ç¡®æ€§æ˜¯æ¯‹åº¸ç½®ç–‘çš„</strong>  </p>
<h3 id="2-3-Unpin-çš„å¼•å…¥"><a href="#2-3-Unpin-çš„å¼•å…¥" class="headerlink" title="2.3 Unpin çš„å¼•å…¥"></a>2.3 Unpin çš„å¼•å…¥</h3><p>ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œwithoutboats å¼•å…¥äº† Unpin çš„æ¦‚å¿µã€‚  </p>
<p>Unpin æ˜¯ä¸€ä¸ª auto traitï¼ŒRust é»˜è®¤ä¸ºæ‰€æœ‰ç»“æ„éƒ½æ·»åŠ äº†è¿™ä¸ªæ ‡è®° Traitï¼ˆåƒ Send å’Œ Syncï¼‰ï¼Œä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªç»“æ„åŒ…å«äº† !Unpin çš„å­—æ®µï¼Œé‚£ä¹ˆå…¶è‡ªèº«ä¹Ÿæ˜¯ !Unpinï¼ˆ !Unpin å±æ€§ä¼šä¼ æ’­ï¼‰ï¼Œå‡ ä¹å”¯ä¸€çš„ !Unpin ç»“æ„å°±æ˜¯ç¼–è¯‘å™¨ä¸º async ä»£ç å—ç”Ÿæˆçš„ GenFutureã€‚å…¶ä½™æ‰€æœ‰çš„åŸºç¡€ç»“æ„ï¼ŒåŒ…æ‹¬ i32, usize éƒ½æ˜¯ Unpin çš„ç»“æ„ï¼Œæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯å¯¹äºå¤æ‚çš„è‡ªå¼•ç”¨ç»“æ„çš„æŒ‡é’ˆã€‚  </p>
<p>å¯¹äºå†…éƒ¨åŒ…å«äº† Unpin ç»“æ„çš„ PinMutï¼Œåªéœ€è¦ä¸ºå…¶å®ç° DerefMut æ–¹æ³•ï¼Œå°±å¯ä»¥ç›´æ¥è·å–åˆ° &amp;mut Tï¼ŒPinMut&lt;â€™a,T&gt; å’Œ &amp;mut Tï¼Œä¹Ÿå°±ä¸éœ€è¦çƒ¦äººçš„ unsafe äº†! ä¹Œæ‹‰ï¼</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> auto <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Unpin</span></span> &#123;&#125;<br><br><span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">&#x27;a</span>, T: Unpin + ?<span class="hljs-built_in">Sized</span>&gt; DerefMut <span class="hljs-keyword">for</span> PinMut&lt;<span class="hljs-symbol">&#x27;a</span>,T&gt;&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Target</span></span> = T;<br><br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">deref_mut</span></span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">Self</span>) -&gt; &amp;<span class="hljs-keyword">mut</span> Self::Target&#123;<br>        ...<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="2-4-æœ€ç»ˆæ–¹æ¡ˆ-Pin"><a href="#2-4-æœ€ç»ˆæ–¹æ¡ˆ-Pin" class="headerlink" title="2.4 æœ€ç»ˆæ–¹æ¡ˆ Pin"></a>2.4 æœ€ç»ˆæ–¹æ¡ˆ Pin</h3><p>æœ€ç»ˆå¼•å…¥æ ‡å‡†åº“çš„æ–¹æ¡ˆå¹¶ä¸æ˜¯ä¸Šé¢çš„ PinMut + PinBoxï¼Œè€Œæ˜¯æ›´åŠ ç®€æ´çš„ä¸€ä¸ªç»Ÿä¸€æ¥å£ï¼š <strong>Pin</strong>  </p>
<p>Pin ä¹Ÿæ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå†…å±‚åŒ…è£…äº†ä¸€ä¸ªæŒ‡é’ˆï¼Œé’ˆå¯¹å†…éƒ¨ä¸åŒçš„æŒ‡é’ˆç±»å‹ï¼Œå®ç°äº†ä¸åŒçš„ traitã€‚</p>
<p>æ ‡å‡†åº“ä¸­æœ‰ä¸‹é¢å‡ ä¸ªå…³é”®çš„å‡½æ•°ï¼Œéƒ½å¯¹å®ƒä»¬åšäº†æ³¨è§£ï¼š  </p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Pin</span></span>&lt;P&gt;&#123;<br>    pointer: P<br>&#125;<br><br><span class="hljs-comment">// ç›´æ¥é€šè¿‡è£¸æŒ‡é’ˆåˆ›å»º Pin æ˜¯ä¸å®‰å…¨çš„ï¼Œä½¿ç”¨è€…å¿…é¡»è¦ç¡®ä¿ï¼Œè¿™ä¸ªæŒ‡é’ˆæ˜¯æœ‰æ•ˆçš„!</span><br><span class="hljs-keyword">impl</span> Deref&lt;P: Deref&gt; Pin&lt;P&gt;&#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">new_unchecked</span></span>(pointer: P) -&gt; Pin&lt;P&gt; &#123;<br>        Pin &#123; pointer &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// åŒç†ï¼Œå°† Pin è½¬æ¢æˆå†…éƒ¨çš„è£¸æŒ‡é’ˆï¼Œä¹Ÿæ˜¯ä¸å®‰å…¨çš„!</span><br><span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">&#x27;a</span>, P&gt; Pin&lt;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> P&gt;&#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">get_unchecked_mut</span></span>(<span class="hljs-keyword">self</span>) -&gt; <span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> P &#123;<br>        <span class="hljs-keyword">self</span>.pointer<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Target::Unpin çš„æŒ‡é’ˆ Pï¼Œå¯ä»¥å®‰å…¨è·å– &amp;mut P::Target</span><br><span class="hljs-keyword">impl</span>&lt;P: DerefMut&lt;Target: Unpin&gt;&gt; <span class="hljs-keyword">for</span> Pin&lt;P&gt; &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">deref_mut</span></span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) -&gt; &amp;<span class="hljs-keyword">mut</span> P::Target &#123;<br>        Pin::get_mut(Pin::as_mut(<span class="hljs-keyword">self</span>))<br>    &#125; <br>&#125;<br><br><span class="hljs-comment">// å¦‚æœè¦ä» Pin&lt;P&gt; åˆ›å»ºå‡º Pin&lt;&amp;&#x27;a mut P::Target&gt;ï¼Œè¿˜æ˜¯å¯ä»¥åŠåˆ°çš„</span><br><span class="hljs-comment">// å› ä¸º Pin å§‹ç»ˆæœ‰è¿™ä¸ªæŒ‡é’ˆçš„æ‰€æœ‰æƒï¼Œæ‰€ä»¥ä¸éœ€è¦æ‹…å¿ƒä¼šå‡ºç° UB è¡Œä¸º</span><br><span class="hljs-keyword">impl</span>&lt;P: DereMut&gt; Pin&lt;P&gt; &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">as_mut</span></span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt;(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) -&gt; Pin&lt;&amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> P::Target&gt; &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123; Pin::new_unchecked(&amp;<span class="hljs-keyword">mut</span> *<span class="hljs-keyword">self</span>.pointer) &#125;<br>    &#125;<br>&#125; <br><br><span class="hljs-comment">// ä» Box åˆ›å»º Pin æœ¬èº«å°±æ˜¯å®‰å…¨çš„ï¼Œå› ä¸º Box å®ç°äº† Unpin</span><br><span class="hljs-keyword">impl</span>&lt;P&gt; <span class="hljs-built_in">From</span>&lt;<span class="hljs-built_in">Box</span>&lt;P&gt;&gt; <span class="hljs-keyword">for</span> Pin&lt;<span class="hljs-built_in">Box</span>&lt;P&gt;&gt; &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">from</span></span>(b: <span class="hljs-built_in">Box</span>&lt;P&gt;) -&gt; Pin&lt;<span class="hljs-built_in">Box</span>&lt;P&gt;&gt;&#123;<br>         <span class="hljs-keyword">unsafe</span> &#123; Pin::new_unchecked(b) &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç å¯èƒ½æœ‰ä¸€ç‚¹ç»•ï¼Œä½†æ˜¯æ ¸å¿ƒå…³æ³¨ç‚¹å°±ä¸¤ä¸ª</p>
<ol>
<li>å¯¹äºå®ç°äº† Deref ç±»å‹çš„ Pï¼Œæ˜¯å¦å¯ä»¥å®‰å…¨åœ°è·å–åˆ°å†…å±‚çš„è¿™ä¸ª pointer</li>
<li>å¯¹äºå®ç°äº† Deref ç±»å‹çš„ Pï¼Œæ˜¯å¦å¯ä»¥å®‰å…¨åœ°è·å–å†…å±‚ pointer æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡</li>
</ol>
<p>å§‹ç»ˆè¦ç‰¢è®° Pin çš„ä½¿å‘½ï¼šéœ€è¦ç¡®ä¿ Rust ä¸­ async/await ä»£ç ä¸­çš„è‡ªå¼•ç”¨ç»“æ„æœ‰æ•ˆï¼Œä¸èƒ½åœ¨ safe code ä¸­ crash Rust çš„å¼ºå®‰å…¨ä¿è¯ã€‚<strong>è¿™æ®µä»£ç å…¶å®æ˜¯æœ‰é—®é¢˜çš„ï¼Œåé¢ä¼šæåˆ°</strong>ã€‚</p>
<p>ç›®å‰çš„ Pin çš„è®¾è®¡ï¼Œæœ€æ ¸å¿ƒçš„ API æ˜¯ get_unchecked_mutï¼Œè¿™é‡Œçš„ <strong>SAFETY</strong> ä¿éšœæ˜¯ï¼šå¦‚æœ <code>&lt;P as DerefMut&gt;::Target</code> æ˜¯ Unpinï¼Œé‚£ä¹ˆæ— æ³•é€šè¿‡å®‰å…¨æ‰‹æ®µå¾—åˆ°å…¶å¯å˜å¼•ç”¨ï¼Œå¦åˆ™å°±å¯èƒ½ç§»åŠ¨å…¶å†…å®¹ï¼Œå¯¼è‡´è‡ªå¼•ç”¨å¤±æ•ˆï¼ˆ99%çš„Unpinéƒ½å‘ç”Ÿåœ¨è‡ªå¼•ç”¨ç»“æ„ä¸Šï¼‰</p>
<p>ç»“åˆä¸Šé¢çš„ Unpin æ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹åŸºæœ¬ç±»å‹å’Œè‡ªå¼•ç”¨ç»“æ„åˆ†åˆ«æ¢è®¨ä¸€ä¸‹åˆç†æ€§ã€‚</p>
<p>åŸºæœ¬ç±»å‹æ˜¯ Unpin çš„ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ <code>Pin::new</code> åˆ›å»ºï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>b.get_mut()</code> è·å–å¯å˜å¼•ç”¨ï¼Œè·Ÿæ™®é€šä½¿ç”¨æŒ‡é’ˆæ²¡æœ‰ä»»ä½•åŒºåˆ«</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> a = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">let</span> b = Pin::new(&amp;<span class="hljs-keyword">mut</span> a);<br><span class="hljs-keyword">let</span> c = b.get_mut();<br></code></pre></td></tr></table></figure>

<p>æ¥æ¥ä¸‹è€ƒè™‘ Pin åœ¨ async/await è¿™ç§è‡ªå¼•ç”¨ç»“æ„ä¸Šçš„è¿ç”¨ï¼ˆå‰ææ˜¯å·²ç»åˆ†é…åœ¨å †ä¸Šäº†ï¼‰ã€‚ä¸ºä»€ä¹ˆå¯¹äºä¸€ä¸ª <code>Box&lt;impl Future&lt;...&gt;&gt;</code>ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å®‰å…¨çš„è·å–ä»£ç å—çš„å¯å˜å¼•ç”¨ï¼Ÿ</p>
<p>æ¢å¥è¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°è·å–ï¼Œå¯èƒ½ä¼šæ€æ ·è¿èƒŒ Rust çš„å®‰å…¨å‡†åˆ™ï¼Ÿ  </p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> a = <span class="hljs-built_in">Box</span>::new(<span class="hljs-keyword">async</span> &#123;&#125;); <span class="hljs-comment">// a is pined on the heap, but &lt;A as DerefMut&gt;::Target is still Unpin</span><br><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> b = <span class="hljs-keyword">unsafe</span> &#123; Pin::new_unchecked(a) &#125;;<br><span class="hljs-keyword">let</span> c = b.as_mut();<br><span class="hljs-comment">// let d = c.get_unchecked_mut();</span><br><span class="hljs-keyword">let</span> d = <span class="hljs-keyword">unsafe</span> &#123; c.get_unchecked_mut() &#125;;<br><br></code></pre></td></tr></table></figure>

<p>å¦‚æœå¯ä»¥å®‰å…¨è·å–åˆ° &amp;mut GenFutureï¼Œä¸€æ—¦åœ¨ä¸¤æ¬¡ poll ä¹‹é—´ï¼Œè¢«ä¸çŸ¥æƒ…çš„ç”¨æˆ·é€šè¿‡ <code>mem::swap()</code> ç­‰æ‰‹æ®µå°†å…¶ç§»åŠ¨å‡ºå»ï¼Œå°±ä¼šå¯¼è‡´è‡ªå¼•ç”¨ç»“æ„å¤±æ•ˆ ğŸ’¥ ã€‚å› æ­¤ï¼Œ<code>Pin::get_mut_unchecked()</code> éœ€è¦é€šè¿‡ unsafe æ¥è®©ç”¨æˆ·è‡ªå·±åšå‡ºä¿è¯ã€‚</p>
<p>å‰é¢æˆ‘ä»¬ä¹Ÿæåˆ°ï¼Œå¦‚æœæƒ³è¦é€šè¿‡ <code>Pin::new()</code> è¿™ç§æ–¹å¼å®‰å…¨åœ°æ„é€  Pinï¼Œéœ€è¦ä¿éšœ <code>&lt;P as DerefMut&gt;::Target: Unpin</code>ï¼Œå¯¹äº Future æ¥è¯´ï¼Œä¹Ÿå°±åªèƒ½ç”¨ Box åŒ…è£…ä¸¤å±‚ï¼Œç¬¬ä¸€æ¬¡æ˜¯å¯¹å†…éƒ¨ Future çš„ Boxï¼Œç¬¬äºŒæ¬¡æ˜¯å¯¹æŒ‡å‘ <code>async &#123;&#125;</code> çš„æŒ‡é’ˆçš„ Boxï¼Œç„¶åæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code>b.as_mut().get_mut()</code> çš„æ–¹å¼å®‰å…¨åœ°è·å–åˆ° <code>&amp;mut Box&lt;...&gt;</code>ï¼ŒWOWï¼æˆ‘ä»¬å¯ä»¥ç§»åŠ¨é‡Œé¢çš„ç»“æ„äº†è€¶ï¼é‚£ä¹ˆ Rust å´©äº†å—ï¼Ÿå°±è¿™ï¼Ÿ</p>
<p>ç­‰ç­‰ï¼Œåˆ«é«˜å…´å¤ªæ—©ï¼Œæ³¨æ„åˆ° Future::poll çš„æ–¹æ³•ç­¾åï¼Œè¦æ±‚è¢« poll çš„ future å¿…é¡»è¦è¢« Pin ä¿æŠ¤èµ·æ¥ï¼Œæˆ‘ä»¬è¿™é‡Œå†æ€ä¹ˆç§»åŠ¨ Box é‡Œé¢çš„ Futureï¼Œéƒ½ä¸å¯èƒ½å½±å“ Future::pollã€‚ä¸€ä¸ª Box å‹æ ¹å°±æ— æ³•è¢« poll</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> a = <span class="hljs-built_in">Box</span>::new(<span class="hljs-built_in">Box</span>::new(<span class="hljs-keyword">async</span> &#123;&#125;));<br><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> b = Pin::new(a);<br><span class="hljs-keyword">let</span> c = b.as_mut().get_mut();<br></code></pre></td></tr></table></figure>

<h2 id="3-å°ç»“"><a href="#3-å°ç»“" class="headerlink" title="3. å°ç»“"></a>3. å°ç»“</h2><p>ä½¿ç”¨ Pin ä¸»è¦æ˜¯ä¸ºäº†é¿å…è‡ªå¼•ç”¨ Future çš„ç§»åŠ¨é—®é¢˜ï¼Œæ ¸å¿ƒä¼šå…³æ³¨ä¸¤ç‚¹ï¼š</p>
<ol>
<li>æ˜¯å¦åˆ†é…åœ¨å †ä¸Š</li>
<li>åœ¨ç»™å‡ºäº† Pin&lt;&amp;mut Self&gt; ä¹‹åï¼Œæ˜¯å¦èƒ½å®‰å…¨åœ°è·å–åˆ° &amp;mut Self</li>
</ol>
<p>å‰è€…é¢å‘ executorï¼Œåè€…é¢å‘ reactor  </p>
<h3 id="3-1-ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒHeap-or-Stack"><a href="#3-1-ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒHeap-or-Stack" class="headerlink" title="3.1 ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒHeap or Stack?"></a>3.1 ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒHeap or Stack?</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// 1. Pin to the heap </span><br><br><span class="hljs-comment">// Box::pin(future) : Pin&lt;Box&lt;T&gt;&gt;</span><br><span class="hljs-comment">// for example</span><br><span class="hljs-keyword">let</span> a: Pin&lt;<span class="hljs-built_in">Box</span>&lt;<span class="hljs-keyword">dyn</span> Future&gt;&gt; = <span class="hljs-built_in">Box</span>::pin(future);<br><br><span class="hljs-comment">// 2. Pin to the stack</span><br><br><span class="hljs-keyword">let</span> f: <span class="hljs-keyword">impl</span> Future = <span class="hljs-keyword">async</span> &#123;&#125;;<br><span class="hljs-comment">// pin-utils crate</span><br>pin_utils:pin_mut!(f);<br>f: Pin&lt;&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">impl</span> Future&lt;..&gt;&gt;;<br></code></pre></td></tr></table></figure>

<p>å¯¹äºä¸€ä¸ªåˆ†é…åœ¨å †ä¸Šçš„ Future æ¥è¯´ï¼Œå½“ç„¶å¯ä»¥éšæ„â€ç§»åŠ¨â€ï¼Œè¿™é‡Œçš„ç§»åŠ¨æŒ‡çš„æ˜¯ï¼Œ<code>Pin&lt;Box&lt;dyn Future&gt;&gt;</code> è¿™ä¸ªç»“æ„çš„æ‰€æœ‰æƒä¸ç®¡å¦‚ä½•è½¬ç§»ï¼Œè¯¥ Future çš„å†…å­˜ä¸€ç›´(Pin)åœ¨å †ä¸Šï¼Œç›´åˆ° Box è¢« Drop æ‰ä¼šè¢«é‡Šæ”¾ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œa é¦–å…ˆè¢« pollï¼Œä¸ç®¡ä¹‹åæ‰€æœ‰æƒå¦‚ä½•è½¬ç§»ï¼Œæ”¹å˜çš„ä¹Ÿåªæ˜¯æ ˆä¸Šçš„æŒ‡é’ˆä½ç½®ï¼Œè¯¥ <code>Box&lt;dyn Future&gt;</code> çš„å†…å®¹ä»ç„¶åœ¨å †ä¸Šï¼Œå› è€Œè‡ªå¼•ç”¨ä¹Ÿæ˜¯æœ‰æ•ˆçš„</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">bar</span></span>()&#123;&#125;<br><br><span class="hljs-keyword">let</span> a = <span class="hljs-built_in">Box</span>::pin(aysnc&#123; bar().<span class="hljs-keyword">await</span>; <span class="hljs-number">1</span>&#125;);<br>a.poll(...);<br><span class="hljs-keyword">let</span> b = a;<br><span class="hljs-keyword">let</span> c = b;<br><span class="hljs-comment">// ä»ç„¶æ˜¯æœ‰æ•ˆçš„</span><br>c.poll(...);<br></code></pre></td></tr></table></figure>

<p>å¯¹äºä¸€ä¸ªåˆ†é…åœ¨æ ˆä¸Šçš„ Future æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦æ‰‹åŠ¨ Poll è¿™ä¸ª Futureï¼Œä¹Ÿéœ€è¦å°†å…¶ Pin ä½ï¼Œæ‰èƒ½æ»¡è¶³ <code>poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;&#39;_&gt;)</code> çš„æ–¹æ³•ç­¾åï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å®ç°ï¼š</p>
<ol>
<li>é€šè¿‡ unsafe ä»£ç ï¼Œ<code>Pin::new_unchecked(&amp;mut a)</code></li>
<li>é€šè¿‡ pin-utils è¿™ä¸ª crate æä¾›çš„ pin_mut! å®æ¥è§£å†³  </li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">bar</span></span>()&#123;&#125;<br><br><span class="hljs-comment">// 1. unsafe å®ç°ï¼Œéœ€è¦æ‰‹åŠ¨ä¿è¯ a ä¸è¢« move</span><br><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> a = bar();<br><span class="hljs-keyword">let</span> f = <span class="hljs-keyword">unsafe</span> &#123; Pin::new_unchecked(&amp;<span class="hljs-keyword">mut</span> a) &#125;;<br>f.poll(...);<br><span class="hljs-keyword">let</span> c = a;<br>f.poll(..); <span class="hljs-comment">// BOM!</span><br><br><span class="hljs-comment">// 2. pin_mut å®å®ç°ï¼Œæ›´åŠ  clever çš„æ–¹å¼ï¼Œå›é¿äº† a è¢« move çš„å¯èƒ½</span><br><span class="hljs-keyword">let</span> a = bar(); <span class="hljs-comment">// a æ˜¯åˆ†é…åœ¨æ ˆä¸Šçš„</span><br>pin_mut!(a);  <span class="hljs-comment">// a now is Pin&lt;&amp;mut impl Future&lt;Output=()&gt;&gt;</span><br>a.poll(...)<br><br></code></pre></td></tr></table></figure>

<p>æ˜¾ç„¶ï¼Œå¯¹äºæ ˆä¸Šçš„ GenFuture æ¥è¯´ï¼Œä»…ä»…æ˜¯ <code>let c = a</code> è¿™ç§è½¬ç§»æ‰€æœ‰æƒçš„æ–¹å¼ï¼Œä¹Ÿä¼šè®© Pin&lt;&amp;mut â€¦&gt; å¤±æ•ˆï¼Œæ ˆä¸Šçš„ Future ä¸€æ—¦å·²ç» pollï¼Œæ ¹æœ¬æ— æ³•åœ¨çº¿ç¨‹é—´è½¬ç§»ï¼Œæ›´åˆ«æè°ƒåº¦äº†ï¼Œåªæœ‰åœ¨æ²¡æœ‰å †å†…å­˜åˆ†é…çš„åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œæ‰ä¼šå®ç°ç‰¹æ®Šçš„ runtimeï¼Œä¿è¯ä¸€å®šåœ¨ç‰¹å®šçš„ Stack ä¸Šå» poll è¿™ä¸ªå·²ç» Pin ä½çš„ Futureã€‚å› ä¸ºä¸€æ—¦ç¦»å¼€äº†è¿™ä¸ªæ‰§è¡Œæ ˆï¼Œè¿™ä¸ª Future ä¹Ÿå°±å¤±æ•ˆäº†ã€‚è€Œç¬¬äºŒç§æ–¹å¼ä¸­çš„ pin_mut!ï¼Œç”±äº Rust å«ç”Ÿå®çš„ç‰¹æ€§ï¼Œå°†å˜é‡ a è¦†ç›–äº†ï¼Œå°±æ— æ³•é€šè¿‡é™¤éå®‰å…¨ä»£ç ä¹‹å¤–çš„æ–¹å¼è·å–åˆ° <code>&amp;mut a</code>ï¼Œä»è€Œä¿è¯å®‰å…¨æ€§ã€‚</p>
<p>å¯¹æ¯”äº† <code>Box::pin å’Œ pin_mut!</code>ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸‹é¢çš„ç»“è®ºï¼š</p>
<ul>
<li>å½“éœ€è¦è¿”å›ä¸€ä¸ª Boxï¼Œæˆ–è€…è¦å°†ä¸€ä¸ª Future ä¿å­˜åœ¨ç»“æ„ä½“ä¸­ï¼Œéœ€è¦ç”¨ <code>Box::pin</code></li>
<li>å½“ç›®çš„æ˜¯åœ¨æŸä¸ªå‡½æ•°ä¸­ä½¿ç”¨ Futureï¼Œæ›´åº”è¯¥ç”¨ä¸Š pin_mut!ï¼Œå¯ä»¥èŠ‚çœ heap allocation çš„å¼€é”€</li>
</ul>
<p>è¿™é‡Œå¿…é¡»è¦è¡¥å……ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œä¹Ÿå°±æ˜¯ Future çš„ä¸¤ç§æ‰§è¡Œæ–¹å¼:</p>
<ol>
<li>runtime::spawn(future)   â€“ é¡¶å±‚ Future</li>
<li>future.await                       â€“ äº¤ç»™ parent Future æ‰§è¡Œ</li>
</ol>
<p>ç¬¬ä¸€ç§æ–¹å¼ä¸­ï¼Œruntime ä¼šé¦–å…ˆå¯¹é¡¶å±‚çš„ Future åšä¸€æ¬¡å †åˆ†é…ï¼Œæˆ‘ä»¬å°±å«å®ƒ root Futureï¼Œæ— è®º root Future æ˜¯å¦æ˜¯ Unpin çš„ï¼Œ<code>Box&lt;dyn Future&gt;</code> ä¸€å®šå®ç°äº† Unpinï¼Œå°±å¯ä»¥äº¤ç»™ executor å®‰å…¨åœ°æ‰§è¡Œ poll äº†</p>
<p>ç¬¬äºŒç§æ–¹å¼ä¸­ï¼Œè¯¥ Future ä¼šè¢« parent Future(async) <strong>æ„ŸçŸ¥</strong>ï¼Œåœ¨è¢« grand parent æ„ŸçŸ¥â€¦ï¼Œåˆ°æœ€åä¹Ÿä¸€å®šæ˜¯é€šè¿‡runtime::spawn æ¥æ‰§è¡Œçš„ã€‚å¦‚æœå°†å…¶è§†ä¸ºä¸€é¢— Future æ ‘ï¼Œå†…éƒ¨æ‰€æœ‰çš„å­å­™ Future éƒ½ä¼šå¤ç”¨ root Future åˆ†é…çš„ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯ spawn ä¸­ä¸€æ¬¡æ€§åˆ†é…åœ¨å †ä¸Šçš„ç©ºé—´ã€‚</p>
<h3 id="3-2-ç¬¬äºŒä¸ªé—®é¢˜ï¼Œè·å–-amp-mut-Self"><a href="#3-2-ç¬¬äºŒä¸ªé—®é¢˜ï¼Œè·å–-amp-mut-Self" class="headerlink" title="3.2 ç¬¬äºŒä¸ªé—®é¢˜ï¼Œè·å– &amp;mut Self"></a>3.2 ç¬¬äºŒä¸ªé—®é¢˜ï¼Œè·å– &amp;mut Self</h3><p>é’ˆå¯¹ async/await å¾—åˆ°çš„ <code>Pin&lt;&amp;mut Future&gt;</code>ï¼ŒPin å¯ä»¥ç¡®ä¿ä¸ä¼šåœ¨å®‰å…¨ä»£ç ä¸­å¾—åˆ° <code>&amp;mut Future</code>ï¼Œä»è€Œè¢«æ»¥ç”¨ï¼›é’ˆå¯¹æ‰‹åŠ¨å®ç°ã€æ²¡æœ‰è‡ªå¼•ç”¨ç»“æ„çš„ã€é¢å‘åº•å±‚ reactor çš„ Futureï¼Œåˆ™å¯ä»¥æ²¡æœ‰ä»»ä½•ä»£ä»·åœ°è·å–åˆ° <code>&amp;mut Future</code>ã€‚</p>
<p>é’ˆå¯¹ executor å’Œ reactorï¼Œæœ‰ä¸¤ç§ä¸åŒçš„ Futureï¼Œasync/await æ˜¯ high-levelï¼Œé¢å‘ executor çš„ Futureï¼Œæ‰‹åŠ¨å®ç°çš„æ˜¯ low-levelï¼Œé¢å‘ç³»ç»Ÿçš„ Futureã€‚åªæœ‰å‰è€…ä¼šå¯¼è‡´è‡ªå¼•ç”¨é—®é¢˜ï¼Œä½†æ˜¯ Rust å›¢é˜ŸèŠ±äº†è¿™ä¹ˆå¤šç²¾åŠ›å»ä¿®è¡¥å®Œå–„ï¼Œè¿™æ‰æ‹¿å‡ºäº†è¿™ä¸ªæ¯”è¾ƒå¥½ç”¨çš„ APIï¼Œå¦‚æœä¸äº†è§£è¿™äº›ï¼Œå®Œå…¨æ²¡æœ‰åŠæ³•æƒ³è±¡ï¼Œå±…ç„¶æœ‰è¿™ä¹ˆå¤šè€ƒé‡çš„å› ç´ ã€‚</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/rust/">rust</a>
                    
                      <a class="hover-with-bg" href="/categories/rust/async/">async</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/12/24/linux/network/zero%20copy/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">zero copy</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/11/24/rust/futures/future-explained2/">
                        <span class="hidden-mobile">future explained(2)</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="https://octodex.github.com/images/jetpacktocat.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>


</body>
</html>
